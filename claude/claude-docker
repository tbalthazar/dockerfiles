#!/bin/bash

# Script to run Claude Code in a Docker container
# Usage: ./run-claude.sh /path/to/project

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

PROJECT_PATH=$(realpath "${1:-.}")

# Verify project path exists
if [ ! -d "$PROJECT_PATH" ]; then
    echo -e "${RED}Error: Project path does not exist: $PROJECT_PATH${NC}"
    exit 1
fi

# Claude credentials directory (standard location)
CLAUDE_CONFIG_DIR="$HOME/.claude"

# Create Claude config directory if it doesn't exist
if [ ! -d "$CLAUDE_CONFIG_DIR" ]; then
    echo -e "${YELLOW}Creating Claude config directory at $CLAUDE_CONFIG_DIR${NC}"
    mkdir -p "$CLAUDE_CONFIG_DIR"
fi

# ~/.claude.json (in home root, not inside ~/.claude/) holds onboarding state, OAuth account,
# theme, and other top-level config â€” must be persisted separately
CLAUDE_JSON_FILE="$HOME/.claude.json"
if [ ! -f "$CLAUDE_JSON_FILE" ]; then
    echo "{}" > "$CLAUDE_JSON_FILE"
fi

# Docker image and container names (single container for all projects)
IMAGE_NAME="tbalthazar/claude-code-dev"
CONTAINER_NAME="claude-dev"

# Pull the latest image from Docker Hub
echo -e "${YELLOW}Pulling $IMAGE_NAME from Docker Hub...${NC}"
docker pull "$IMAGE_NAME"

echo -e "${GREEN}Starting Claude Code container${NC}"
echo -e "Project path: ${GREEN}$PROJECT_PATH${NC}"
echo -e "Claude config: ${GREEN}$CLAUDE_CONFIG_DIR${NC}"

# Always use docker run with --rm to auto-cleanup
# This ensures we get a fresh container each time with the correct mounts
docker run -it --rm \
    --name "$CONTAINER_NAME" \
    -v "$PROJECT_PATH:/workspace:rw" \
    -v "$CLAUDE_CONFIG_DIR:/home/user/.claude:rw" \
    -v "$CLAUDE_JSON_FILE:/home/user/.claude.json:rw" \
    -w /workspace \
    "$IMAGE_NAME"

echo -e "${GREEN}Container session ended${NC}"
